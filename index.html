<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Less-Addictive Library v2</title>
    <style>
        body { font-family: sans-serif; background-color: #b1b1b1; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; }
        
        /* 検索フォーム用のスタイル */
        .search-container { margin-bottom: 20px; text-align: center; }
        #searchInput { width: 50%; padding: 10px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; }

        #video-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        
        /* カード型のデザインに変更 */
        .video-card {
            width: 320px; /* 少し小さくして情報を見やすく */
            background-color: #b1b1b1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
            display: flex; /* flexboxを使って中身を整理 */
            flex-direction: column;
        }
        .video-card iframe {
            width: 100%;
            height: 180px; /* 16:9比率 */
            border: none;
        }
        .video-info {
            padding: 15px;
            flex-grow: 1; /* 高さがバラバラにならないように */
            display: flex;
            flex-direction: column;
        }
        .video-title {
            font-weight: bold;
            font-size: 16px;
            margin: 0 0 10px 0;
            /* 2行までに制限して、はみ出たら ... で表示 */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .channel-title {
            font-size: 14px;
            color: #666;
            margin: 0 0 auto 0; /* 日付を一番下に配置するためのトリック */
        }
        .added-date {
            font-size: 12px;
            color: #999;
            text-align: right;
            margin-top: 10px;
        }

        #status-message { text-align: center; font-size: 1.2em; color: #666; padding: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>My Less-Addictive Library v2</h1>
        
        <!-- 検索フォームを追加 -->
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="タイトルやチャンネル名で検索...">
        </div>

        <div id="status-message">動画を読み込んでいます...</div>
        <div id="video-container"></div>
    </div>

    <script>
        const gasApiUrl = "https://script.google.com/macros/s/AKfycbw2WfyVPMOuWnZGsmWFMqTWr2xqbKal17rIOFaarSn4MhK6mvT4fqbvXVfIjVXF4P8/exec"; // ★★★ v2のGAS URLに書き換えてください

        let allVideos = []; // 全ての「動画オブジェクト」を保持する配列
        let filteredVideos = []; // 現在表示されている動画のリスト

        // -----------------------------------------------------------------
        // 検索と表示のメイン関数
        // -----------------------------------------------------------------
        function renderVideos() {
            const container = document.getElementById('video-container');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            container.innerHTML = ''; // コンテナを毎回空にする

            // 検索語句でフィルタリング
            filteredVideos = allVideos.filter(video => {
                return video.title.toLowerCase().includes(searchTerm) || 
                       video.channelTitle.toLowerCase().includes(searchTerm);
            });

            if (filteredVideos.length === 0) {
                document.getElementById('status-message').innerText = '該当する動画はありません。';
                document.getElementById('status-message').style.display = 'block';
            } else {
                document.getElementById('status-message').style.display = 'none';
            }

            // フィルタリングされた結果を表示
            filteredVideos.forEach(video => {
                const card = document.createElement('div');
                card.className = 'video-card';

                const iframe = document.createElement('iframe');
                iframe.src = `https://www.youtube-nocookie.com/embed/${video.videoId}?rel=0`;
                iframe.loading = "lazy";
                iframe.allowFullscreen = true;

                const info = document.createElement('div');
                info.className = 'video-info';
                
                const title = document.createElement('p');
                title.className = 'video-title';
                title.textContent = video.title;

                const channel = document.createElement('p');
                channel.className = 'channel-title';
                channel.textContent = video.channelTitle;

                const date = document.createElement('p');
                date.className = 'added-date';
                date.textContent = `追加日: ${new Date(video.addedAt).toLocaleDateString()}`;

                info.appendChild(title);
                info.appendChild(channel);
                info.appendChild(date);
                card.appendChild(iframe);
                card.appendChild(info);
                container.appendChild(card);
            });
        }

        // -----------------------------------------------------------------
        // イベントリスナー
        // -----------------------------------------------------------------
        document.getElementById('searchInput').addEventListener('input', renderVideos);

        // -----------------------------------------------------------------
        // ページ初期化のメイン処理
        // -----------------------------------------------------------------
        window.onload = function() {
            const fetchUrl = gasApiUrl + "?action=getVideos";
            const statusMessage = document.getElementById('status-message');

            fetch(fetchUrl)
                .then(response => response.json())
                .then(data => {
                    // 【変更】dataが直接動画オブジェクトの配列になっている
                    if (data && data.length > 0) {
                        // 日付が新しい順にソート
                        allVideos = data.sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt));
                        renderVideos(); // 最初の描画
                    } else {
                        statusMessage.innerText = '再生できる動画がありません。';
                    }
                })
                .catch(error => {
                    console.error('動画の読み込みに失敗しました:', error);
                    statusMessage.innerText = '動画の読み込みに失敗しました。';
                });
        };
    </script>
</body>
</html>
